{{ define "base" }}
<!DOCTYPE html>
<html lang="en" class="">

<head>
    <title>Vanilla OS Packages Search</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description"
        content="This site provides you with information about all the packages available in the Vanilla OS repository">
    <link rel="icon" href="/static/favicon.ico">
    <link rel="stylesheet" href="/static/css/index.css">
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        brand: {
                            50: '#fffbf0',
                            100: '#fff3d6',
                            500: '#FBBD4E',
                            600: '#e6a32e',
                            900: '#4d3200',
                        }
                    },
                    fontFamily: {
                        outfit: ['Outfit', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <script>
        // Check local storage or preference for dark mode
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    </script>
</head>

<body
    class="bg-white dark:bg-zinc-950 text-zinc-900 dark:text-zinc-100 font-outfit antialiased selection:bg-brand-500/20 flex flex-col min-h-screen">
    <header
        class="fixed top-0 inset-x-0 h-16 bg-white/80 dark:bg-zinc-950/80 backdrop-blur-md border-b border-zinc-200 dark:border-zinc-800 z-[60]">
        <div class="max-w-7xl mx-auto px-4 h-full flex items-center justify-between">
            <div class="flex items-center gap-3">
                <a href="/" class="flex items-center gap-3 group">
                    <img class="w-8 h-8 rounded-lg shadow-sm group-hover:shadow-md transition-all" alt="Logo"
                        src="/static/images/logo.svg">
                    <span
                        class="font-semibold text-sm tracking-tight group-hover:text-zinc-600 dark:group-hover:text-zinc-300 transition-colors inline-block">Vanilla
                        OS Packages</span>
                </a>
            </div>

            <div class="flex items-center gap-2 md:gap-4">
                {{ if .ShowSearchBar }}
                <form action="/search" method="get" class="flex items-center gap-2">
                    <div
                        class="hidden md:flex items-center border border-zinc-200 dark:border-zinc-800 rounded-md bg-zinc-50 dark:bg-zinc-900 px-1 relative z-50">

                        <!-- Branch Selector -->
                        <div class="relative custom-select-container">
                            <button type="button"
                                class="custom-select-trigger flex items-center gap-1 bg-transparent text-xs font-medium text-zinc-600 dark:text-zinc-400 focus:outline-none py-1.5 px-2 hover:text-zinc-900 dark:hover:text-zinc-200 transition-colors"
                                onclick="toggleCustomSelect('branchDropdown')">
                                <span id="branchLabel">{{ .Branch }}</span>
                                <span class="material-symbols-outlined text-[16px]">expand_more</span>
                            </button>
                            <div id="branchDropdown"
                                class="hidden absolute top-full left-0 mt-1 w-32 bg-white dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-800 rounded-lg shadow-lg py-1 z-50">
                                <div class="px-2 py-1" onclick="selectBranch('main')">
                                    <div
                                        class="flex items-center gap-2 px-2 py-1.5 rounded-md hover:bg-zinc-100 dark:hover:bg-zinc-800 cursor-pointer text-xs text-zinc-600 dark:text-zinc-300">
                                        <span>main</span>
                                        {{ if eq .Branch "main" }}<span
                                            class="material-symbols-outlined text-[14px] ml-auto text-brand-500">check</span>{{
                                        end }}
                                    </div>
                                </div>
                                <div class="px-2 py-1" onclick="selectBranch('testing')">
                                    <div
                                        class="flex items-center gap-2 px-2 py-1.5 rounded-md hover:bg-zinc-100 dark:hover:bg-zinc-800 cursor-pointer text-xs text-zinc-600 dark:text-zinc-300">
                                        <span>testing</span>
                                        {{ if eq .Branch "testing" }}<span
                                            class="material-symbols-outlined text-[14px] ml-auto text-brand-500">check</span>{{
                                        end }}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="w-px h-3 bg-zinc-200 dark:bg-zinc-700 mx-1"></div>

                        <!-- Arch Selector -->
                        <div class="relative custom-select-container">
                            <button type="button"
                                class="custom-select-trigger flex items-center gap-1 bg-transparent text-xs font-medium text-zinc-600 dark:text-zinc-400 focus:outline-none py-1.5 px-2 hover:text-zinc-900 dark:hover:text-zinc-200 transition-colors"
                                onclick="toggleCustomSelect('archDropdown')">
                                <span id="archLabel">{{ .CurrentArch }}</span>
                                <span class="material-symbols-outlined text-[16px]">expand_more</span>
                            </button>
                            <div id="archDropdown"
                                class="hidden absolute top-full left-0 mt-1 w-32 bg-white dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-800 rounded-lg shadow-lg py-1 z-50">
                                {{ range .Archs }}
                                <div class="px-2 py-1" onclick="selectArch('{{ . }}')">
                                    <div
                                        class="flex items-center gap-2 px-2 py-1.5 rounded-md hover:bg-zinc-100 dark:hover:bg-zinc-800 cursor-pointer text-xs text-zinc-600 dark:text-zinc-300">
                                        <span>{{ . }}</span>
                                        {{ if eq $.CurrentArch . }}<span
                                            class="material-symbols-outlined text-[14px] ml-auto text-brand-500">check</span>{{
                                        end }}
                                    </div>
                                </div>
                                {{ end }}
                            </div>
                        </div>

                    </div>

                    <div class="relative group">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <span
                                class="material-symbols-outlined text-[18px] text-zinc-400 group-focus-within:text-brand-500 transition-colors">search</span>
                        </div>
                        <input id="headerSearchInput"
                            class="pl-9 pr-12 py-1.5 rounded-md bg-zinc-50 dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-800 text-sm text-zinc-900 dark:text-zinc-100 focus:ring-2 focus:ring-brand-500/20 focus:border-brand-500 outline-none transition-all w-48 md:w-64 placeholder-zinc-500"
                            type="text" placeholder="Search..." name="q" value="{{ .Query }}" autocomplete="off">
                        <div class="absolute inset-y-0 right-0 pr-2 flex items-center pointer-events-none">
                            <span
                                class="text-[10px] font-medium text-zinc-400 border border-zinc-200 dark:border-zinc-700 rounded px-1.5 py-0.5 bg-white dark:bg-zinc-800">Ctrl
                                K</span>
                        </div>

                        <!-- Real-time Search Results -->
                        <div id="headerSearchResults"
                            class="hidden absolute top-full left-1/2 -translate-x-1/2 mt-2 bg-white/95 dark:bg-zinc-950/95 backdrop-blur-xl border border-zinc-200 dark:border-zinc-800 rounded-xl shadow-2xl py-2 z-50 max-h-96 overflow-y-auto w-[400px]">
                            <!-- Results injected here -->
                        </div>
                    </div>
                </form>
                {{ end }}

                <div class="hidden sm:block w-px h-4 bg-zinc-200 dark:bg-zinc-800"></div>

                <button onclick="toggleTheme()"
                    class="p-2 rounded-md hover:bg-zinc-100 dark:hover:bg-zinc-900 text-zinc-500 transition-colors">
                    <span id="theme-icon" class="material-symbols-outlined text-[20px]">light_mode</span>
                </button>

                <a class="p-2 rounded-md hover:bg-zinc-100 dark:hover:bg-zinc-900 text-zinc-500 transition-colors"
                    title="Go to repo" href="https://repo2.vanillaos.org">
                    <span class="material-symbols-outlined text-[20px]">storage</span>
                </a>
            </div>
        </div>
    </header>

    <div class="pt-16 pb-12 flex-1">
        {{ template "content" . }}
    </div>

    <footer class="border-t border-zinc-200 dark:border-zinc-800 mt-auto bg-white dark:bg-zinc-950">
        <div
            class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8 flex flex-col md:flex-row justify-between items-center text-xs text-zinc-500 dark:text-zinc-400 gap-4">
            <div class="flex flex-col md:flex-row gap-4 items-center">
                <p>
                    Eratosthenes powered by
                    <a href="https://vanillaos.org" target="_blank"
                        class="font-medium text-brand-600 dark:text-brand-400 hover:underline">
                        Vanilla OS
                    </a>.
                </p>
                <div class="hidden md:block w-px h-3 bg-zinc-200 dark:bg-zinc-800"></div>
                <p>
                    Empowered by
                    <a href="https://github.com/mirkobrombin/go-warp" target="_blank"
                        class="font-medium text-brand-600 dark:text-brand-400 hover:underline">go-warp</a>
                    &
                    <a href="https://github.com/mirkobrombin/go-slipstream" target="_blank"
                        class="font-medium text-brand-600 dark:text-brand-400 hover:underline">go-slipstream</a>
                </p>
            </div>
            <p>v2.0.0</p>
        </div>
    </footer>

    <script>
        const html = document.documentElement;
        function toggleTheme() {
            const isDark = html.classList.toggle('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            updateThemeIcon();
        }

        function updateThemeIcon() {
            const icon = document.getElementById('theme-icon');
            if (html.classList.contains('dark')) {
                icon.textContent = 'dark_mode';
            } else {
                icon.textContent = 'light_mode';
            }
        }
        updateThemeIcon();

        // Custom Select Logic for Header
        function toggleCustomSelect(id) {
            const dropdown = document.getElementById(id);
            if (dropdown.classList.contains('hidden')) {
                // Close others
                document.querySelectorAll('.custom-select-container > div[id$="Dropdown"]').forEach(el => el.classList.add('hidden'));
                dropdown.classList.remove('hidden');
            } else {
                dropdown.classList.add('hidden');
            }
        }

        function selectBranch(val) {
            document.cookie = "branch=" + val + "; path=/";
            location.reload();
        }

        function selectArch(val) {
            document.cookie = "arch=" + val + "; path=/";
            location.reload();
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', function (event) {
            if (!event.target.closest('.custom-select-container')) {
                document.querySelectorAll('.custom-select-container > div[id$="Dropdown"]').forEach(el => el.classList.add('hidden'));
            }
        });

        // --- Real-time Search Logic ---
        const searchInput = document.getElementById('headerSearchInput');
        const searchResults = document.getElementById('headerSearchResults');
        let searchDebounce;

        // Ctrl+K Shortcut
        document.addEventListener('keydown', function (e) {
            if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                e.preventDefault();
                searchInput?.focus();
            }
        });

        if (searchInput) {
            searchInput.addEventListener('input', function () {
                clearTimeout(searchDebounce);
                const query = this.value.trim();

                if (query.length < 3) {
                    searchResults.classList.add('hidden');
                    searchResults.innerHTML = '';
                    return;
                }

                searchDebounce = setTimeout(async () => {
                    try {
                        const branch = document.cookie.split('; ').find(row => row.startsWith('branch='))?.split('=')[1] || 'main';
                        const arch = document.cookie.split('; ').find(row => row.startsWith('arch='))?.split('=')[1] || 'amd64';

                        const res = await fetch(`/search?q=${encodeURIComponent(query)}&branch=${branch}&arch=${arch}`, {
                            headers: { 'Accept': 'application/json' }
                        });

                        if (!res.ok) throw new Error('Search failed');
                        const packages = await res.json();

                        renderSearchResults(packages);
                    } catch (err) {
                        console.error(err);
                    }
                }, 300);
            });

            // Hide results on click outside
            document.addEventListener('click', function (e) {
                if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
                    searchResults.classList.add('hidden');
                }
            });

            // Show results on focus if input has value
            searchInput.addEventListener('focus', function () {
                if (this.value.trim().length >= 3 && searchResults.innerHTML !== '') {
                    searchResults.classList.remove('hidden');
                }
            });
        }

        function renderSearchResults(packages) {
            if (!packages || packages.length === 0) {
                searchResults.innerHTML = `
                    <div class="px-4 py-3 text-sm text-zinc-500 dark:text-zinc-400 text-center">
                        No results found.
                    </div>
                `;
                searchResults.classList.remove('hidden');
                return;
            }

            const html = packages.slice(0, 5).map(pkg => `
                <a href="/package/${pkg.name}" class="block px-4 py-3 hover:bg-zinc-50/50 dark:hover:bg-zinc-800/50 transition-all border-l-2 border-transparent hover:border-brand-500 group">
                    <div class="flex items-center justify-between mb-0.5">
                        <span class="font-medium text-sm text-zinc-900 dark:text-zinc-100 group-hover:text-brand-600 dark:group-hover:text-brand-400 transition-colors">${pkg.name}</span>
                        <span class="text-[10px] font-medium text-zinc-500 dark:text-zinc-400 bg-zinc-100 dark:bg-zinc-800 px-1.5 py-0.5 rounded-full">${pkg.version}</span>
                    </div>
                    <p class="text-xs text-zinc-500 dark:text-zinc-400 line-clamp-1">${pkg.description}</p>
                </a>
            `).join('');

            const moreHtml = packages.length > 5 ? `
                 <a href="/search?q=${encodeURIComponent(searchInput.value)}" class="block px-4 py-3 text-xs font-medium text-center text-brand-600 dark:text-brand-400 hover:text-brand-700 dark:hover:text-brand-300 border-t border-zinc-100 dark:border-zinc-800/50 hover:bg-zinc-50 dark:hover:bg-zinc-900 transition-colors">
                    View all ${packages.length} results
                </a>
            ` : '';

            searchResults.innerHTML = html + moreHtml;
            searchResults.classList.remove('hidden');
        }
    </script>
</body>

</html>
{{ end }}